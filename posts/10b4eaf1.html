<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Kafka的多副本同步机制 | 纳斯卡可`Blog</title><meta name="author" content="纳斯卡可,2843035026@qq.com"><meta name="copyright" content="纳斯卡可"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="深度解析 Kafka 多副本同步机制：从 HW 到 Leader Epoch在分布式系统中，数据的一致性和高可用性永远是核心课题。Kafka 作为顶级消息流平台，其高可靠性主要依赖于多副本（Replication）机制。本文将带你深入底层，剖析 Kafka 副本之间是如何协同工作、确保数据不丢不重的。  一、 核心角色与概念在深入同步流程之前，我们先统一几个关键术语：  Leader 副本：每个分"><meta property="og:type" content="article"><meta property="og:title" content="Kafka的多副本同步机制"><meta property="og:url" content="https://nmcb666.vip/posts/10b4eaf1.html"><meta property="og:site_name" content="纳斯卡可&#96;Blog"><meta property="og:description" content="深度解析 Kafka 多副本同步机制：从 HW 到 Leader Epoch在分布式系统中，数据的一致性和高可用性永远是核心课题。Kafka 作为顶级消息流平台，其高可靠性主要依赖于多副本（Replication）机制。本文将带你深入底层，剖析 Kafka 副本之间是如何协同工作、确保数据不丢不重的。  一、 核心角色与概念在深入同步流程之前，我们先统一几个关键术语：  Leader 副本：每个分"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/666.jpg"><meta property="article:published_time" content="2026-02-16T17:22:19.000Z"><meta property="article:modified_time" content="2026-02-21T04:46:00.811Z"><meta property="article:author" content="纳斯卡可"><meta property="article:tag" content="八股"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/666.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kafka的多副本同步机制",
  "url": "https://nmcb666.vip/posts/10b4eaf1.html",
  "image": "https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/666.jpg",
  "datePublished": "2026-02-16T17:22:19.000Z",
  "dateModified": "2026-02-21T04:46:00.811Z",
  "author": [
    {
      "@type": "Person",
      "name": "纳斯卡可",
      "url": "https://nmcb666.vip"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://nmcb666.vip/posts/10b4eaf1.html"><link rel="preconnect" href="//cdn.jsdmirror.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#13227a"><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/128.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"><link rel="mask-icon" href="/img/siteicon/128.png" color="#5bbad5"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>(() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdmirror.com/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Kafka的多副本同步机制",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload='this.media="all"'><script defer src="/js/title.js"></script><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/bilibiliBanner/banner.css"><link rel="stylesheet" href="https://cdn.jsdmirror.com/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/css/runtime/runtime.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload='this.media="all"'><script src="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload='this.media="screen"'><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="纳斯卡可`Blog" type="application/atom+xml"></head><body><div id="web_bg" style="background-image:url(https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/default_cover_14.webp)"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/666.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">48</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-home"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-home"></use></svg> <span>Home</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-archive"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-archive"></use></svg> <span>归档</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="fa-fw icon-tags"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg> <span>标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/bangumis/index.html"><i class="fa-fw icon-bilibili"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-bilibili"></use></svg> <span>追番</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-xinfeng"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xinfeng"></use></svg> <span>留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/links/"><i class="fa-fw icon-lianjie"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg> <span>友链</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-zhifeiji"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zhifeiji"></use></svg> <span>关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">纳斯卡可`Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Kafka的多副本同步机制</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i> <span>返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-home"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-home"></use></svg> <span>Home</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-archive"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-archive"></use></svg> <span>归档</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="fa-fw icon-tags"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg> <span>标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/bangumis/index.html"><i class="fa-fw icon-bilibili"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-bilibili"></use></svg> <span>追番</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-xinfeng"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xinfeng"></use></svg> <span>留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/links/"><i class="fa-fw icon-lianjie"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg> <span>友链</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-zhifeiji"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zhifeiji"></use></svg> <span>关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Kafka的多副本同步机制</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-02-16T17:22:19.000Z" title="发表于 2026-02-16 17:22:19">2026-02-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-21T04:46:00.811Z" title="更新于 2026-02-21 04:46:00">2026-02-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="深度解析-Kafka-多副本同步机制：从-HW-到-Leader-Epoch"><a href="#深度解析-Kafka-多副本同步机制：从-HW-到-Leader-Epoch" class="headerlink" title="深度解析 Kafka 多副本同步机制：从 HW 到 Leader Epoch"></a>深度解析 Kafka 多副本同步机制：从 HW 到 Leader Epoch</h1><p>在分布式系统中，数据的一致性和高可用性永远是核心课题。Kafka 作为顶级消息流平台，其高可靠性主要依赖于<strong>多副本（Replication）机制</strong>。本文将带你深入底层，剖析 Kafka 副本之间是如何协同工作、确保数据不丢不重的。</p><hr><h2 id="一、-核心角色与概念"><a href="#一、-核心角色与概念" class="headerlink" title="一、 核心角色与概念"></a>一、 核心角色与概念</h2><p>在深入同步流程之前，我们先统一几个关键术语：</p><ol><li><strong>Leader 副本</strong>：每个分区（Partition）在创建时，由 <strong>Controller</strong> 负责指派 Leader。Controller 会从 <strong>AR（Assigned Replicas，所有副本）</strong> 列表中找到第一个在 <strong>ISR</strong> 中的副本作为优先 Leader。所有的读写请求都由 Leader 处理。</li><li><strong>Follower 副本</strong>：不处理客户端请求，只负责从 Leader 拉取（Pull）数据。</li><li><strong>ISR (In-Sync Replicas)</strong>：与 Leader 保持同步的副本集合。判断标准是 <code>replica.lag.time.max.ms</code>（默认 30s），只要 Follower 在这个时间内向 Leader 发起过同步请求且进度没落后太多，就留在 ISR 中。</li><li><strong>LEO (Log End Offset)</strong>：下一条待写入消息的位移。每个副本都有自己的 LEO。</li><li><strong>HW (High Watermark)</strong>：高水位。这是消费者能看到的最高位移。<strong>HW 之前的消息被认为是“已提交”的。</strong></li></ol><hr><h2 id="二、-数据同步全过程：HW-的动态演进"><a href="#二、-数据同步全过程：HW-的动态演进" class="headerlink" title="二、 数据同步全过程：HW 的动态演进"></a>二、 数据同步全过程：HW 的动态演进</h2><p>Kafka 的同步机制是一个“两步走”的拉取模型。</p><h3 id="1-第一步：Follower-拉取数据"><a href="#1-第一步：Follower-拉取数据" class="headerlink" title="1. 第一步：Follower 拉取数据"></a>1. 第一步：Follower 拉取数据</h3><p>Follower 会周期性地向 Leader 发送 <code>FetchRequest</code>。请求中包含 Follower 自己当前的 <strong>LEO</strong>。</p><h3 id="2-第二步：Leader-更新-LEO-与-HW"><a href="#2-第二步：Leader-更新-LEO-与-HW" class="headerlink" title="2. 第二步：Leader 更新 LEO 与 HW"></a>2. 第二步：Leader 更新 LEO 与 HW</h3><p>当 Leader 收到 Fetch 请求后：</p><ul><li><strong>更新 LEO 记录</strong>：Leader 会在内存中记录这个 Follower 的 LEO。</li><li><strong>计算 HW</strong>：Leader 会取 <strong>ISR 集合中所有副本 LEO 的最小值</strong>，作为该分区新的 HW。</li></ul><h3 id="3-第三步：Follower-更新-HW"><a href="#3-第三步：Follower-更新-HW" class="headerlink" title="3. 第三步：Follower 更新 HW"></a>3. 第三步：Follower 更新 HW</h3><p>Leader 在处理完 Fetch 请求后，会将<strong>当前分区的 HW</strong> 随数据一起返回给 Follower。<br>Follower 收到响应后：</p><ul><li>将数据写入本地日志，更新自己的 <strong>LEO</strong>。</li><li>比较“自己的 LEO”和“Leader 传回的 HW”，<strong>取最小值</strong>作为自己本地的 HW。</li></ul><blockquote><p><strong>注意：HW 更新的“滞后性”</strong><br>由于 HW 是在 Fetch Response 中带回的，这意味着 Follower 自身的 HW 总是比 Leader 慢一轮拉取。</p></blockquote><hr><h2 id="三、-HW-机制的局限性：为什么需要-Leader-Epoch？"><a href="#三、-HW-机制的局限性：为什么需要-Leader-Epoch？" class="headerlink" title="三、 HW 机制的局限性：为什么需要 Leader Epoch？"></a>三、 HW 机制的局限性：为什么需要 Leader Epoch？</h2><p>在 Kafka 0.11 版本之前，仅仅依靠 HW 存在两个严重问题：<strong>数据丢失</strong>和<strong>数据不一致</strong>。</p><p><strong>场景模拟：</strong><br>假设 A 是 Leader，B 是 Follower。</p><ol><li>A 收到消息并写入，A 的 LEO=1, HW=1。B 同步了消息，但还没来得及收到 A 的 HW 更新回传，此时 B 的 LEO=1, HW=0。</li><li>B 重启。根据 HW 机制，B 重启后会将日志<strong>截断</strong>到自己的 HW（即位移 0），位移 1 的数据丢失了。</li><li>B 截断后尝试拉取 A。此时 A 突然宕机，B 被选为新 Leader。</li><li>A 恢复后成为 Follower，发现自己的 HW 也是 1，与 B 似乎一致，但实际上 B 已经丢了数据。</li></ol><p>为了解决这个问题，Kafka 引入了 <strong>Leader Epoch</strong>。</p><h3 id="Leader-Epoch-机制"><a href="#Leader-Epoch-机制" class="headerlink" title="Leader Epoch 机制"></a>Leader Epoch 机制</h3><p>Leader Epoch 相当于一个“版本号”+“起始位移”。</p><ul><li>当 Follower 重启后，<strong>不再直接根据 HW 截断日志</strong>。</li><li>它会先向 Leader 发送一个 <code>OffsetForLeaderEpochRequest</code>，询问当前 Epoch 的最后一个位移。</li><li>通过 Leader 返回的确认信息，Follower 能够判断该位移的数据是否真的失效，从而避免了盲目截断导致的数据丢失。</li></ul><hr><h2 id="四、-总结"><a href="#四、-总结" class="headerlink" title="四、 总结"></a>四、 总结</h2><p>Kafka 的副本同步机制可以概括为：</p><ol><li><strong>由 Controller 指派优先副本作为 Leader</strong>，确保负载均衡。</li><li><strong>ISR 机制保证可靠性</strong>，动态剔除掉队副本，确保只有同步的副本能竞选 Leader。</li><li><strong>HW 机制定义可见性边界</strong>，通过拉取模型（Pull）异步更新各副本水位。</li><li><strong>Leader Epoch 修复了 HW 的物理缺陷</strong>，在极端的宕机重启场景下保障了数据的绝对一致性。</li></ol><p><strong>一句话总结：</strong><br>HW 决定了你能消费到哪，而 ISR 和 Leader Epoch 决定了你的数据有多安全。</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者:</span> <span class="post-copyright-info"><a href="https://nmcb666.vip">纳斯卡可</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接:</span> <span class="post-copyright-info"><a href="https://nmcb666.vip/posts/10b4eaf1.html">https://nmcb666.vip/posts/10b4eaf1.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://nmcb666.vip" target="_blank">纳斯卡可`Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%85%AB%E8%82%A1/">八股</a></div><div class="post-share"><div class="social-share" data-image="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/666.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdmirror.com/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/wechat.jpg" alt="wechat"></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/34e1e2ae.html" title="并发与串行下的接口幂等"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">并发与串行下的接口幂等</div></div><div class="info-2"><div class="info-item-1">架构漫谈：别让分布式锁成“背锅侠”——接口幂等性的深度思考与实践在分布式系统的开发中，“接口幂等性（Idempotency）”是一个老生常谈却又极易踩坑的话题。尤其是涉及资金交易、订单状态流转的业务（如提现、转账、支付），一旦防重逻辑出现漏洞，轻则客诉，重则产生直接资损。 很多开发者在面对“重复请求”时，第一反应往往是：“加个 Redis 分布式锁不就行了吗？” 然而，在经历过几次血淋淋的生产事故后，你会发现：光靠分布式锁，根本拦不住真正的重复执行。 今天，我们就来深度剖析一下，为什么分布式锁不能和幂等画等号，以及在企业级架构中，究竟该如何构建一道坚不可摧的幂等防线。 1. 灾难现场：被击穿的“加锁”逻辑假设我们有一个“异步出款（提现）”的消费者（Kafka Consumer）。由于网络抖动，Kafka 发生了消息积压或超时重发，导致同一笔订单的出款消息被消费了两次。 小白开发者的防御代码往往是这样写的： 12345678910111213// 反面教材：单纯加锁public void processPayout(String orderId) &#123; if (r...</div></div></div></a><a class="pagination-related" href="/posts/ae7d08b8.html" title="在DDD下怎么高效实现一人一单+库存超卖"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">在DDD下怎么高效实现一人一单+库存超卖</div></div><div class="info-2"><div class="info-item-1">[DDD实战] 高并发下的“一人一单”与库存扣减在电商系统的“秒杀”或“限购”场景中，创建订单看似简单，实则暗流涌动。特别是在面临以下两个核心约束时，传统的CRUD思维往往会陷入性能瓶颈或逻辑混乱： 购买资格校验：例如“一人一单”、“一人一天限购5单”。 高并发库存扣减：如何防止超卖，同时保证高性能。 本文将复盘我在项目中遇到的领域建模难点，探讨如何通过引入新的聚合根、Redis+Lua原子操作以及最终一致性策略来优雅解决这些问题。 一、 领域建模的困局：限购逻辑该放哪？限购逻辑的核心在于：“判断一个用户在特定时间窗口内，对某个商品的购买历史是否满足条件。” 在设计初期，我们面临着模型归属的抉择： ❌ 方案一：放在“订单（Order）”聚合根中思路：在创建新订单时，查询该用户所有的历史订单，统计购买数量。问题： 性能极差：随着时间推移，历史订单表数据量巨大，实时统计（Count/Sum）是数据库杀手。 职责不清：订单聚合根应该关注“本次交易”的状态流转，而不是背负“历史审计”的责任。 ❌ 方案二：放在“用户（User）”聚合根中思路：在用户模型中增加一个List&lt;...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/6079905e.html" title="AQS是什么？"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-31</div><div class="info-item-2">AQS是什么？</div></div><div class="info-2"><div class="info-item-1">【Java并发】AQS详解：JUC包背后的“幕后大佬”在 Java 并发编程（JUC）的世界里，我们经常使用 ReentrantLock、CountDownLatch、Semaphore 这些赫赫有名的工具类。 但你是否想过，这些功能各异的工具背后，其实共用着同一套“底盘”？ 这就是我们今天要聊的主角——AQS (AbstractQueuedSynchronizer，抽象队列同步器)。它是 JUC 包的心脏，掌握了它，你就掌握了 Java 并发的半壁江山。 一、 什么是 AQS？AQS 是一个用于构建锁和同步器的框架。 如果把 ReentrantLock、CountDownLatch 等比作是成品的汽车（跑车、卡车、公交车），那么 AQS 就是通用的汽车底盘和引擎。 AQS 负责脏活累活：它处理了线程的排队、阻塞、唤醒、线程安全等最复杂的底层逻辑。 同步器负责业务逻辑：具体的工具类只需要告诉 AQS，“什么时候算获取锁成功”，“资源一共有多少”，剩下的交给 AQS 即可。 简单来说，AQS 是一个“原材料”，我们可以根据它加工出各种各样的同步器。 二、 AQS 的核心架构AQ...</div></div></div></a><a class="pagination-related" href="/posts/9edb0695.html" title="Java中的NIO就是操作系统的同步非阻塞IO吗？"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-02-07</div><div class="info-item-2">Java中的NIO就是操作系统的同步非阻塞IO吗？</div></div><div class="info-2"><div class="info-item-1">Java NIO：不仅仅是“非阻塞”，更是 IO 模型的“Pro Max”在 Java 后端面试或高并发系统设计的讨论中，NIO (New I/O) 永远是一个绕不开的话题。 很多同学在初学时，往往会被教科书上的定义绕晕： “NIO 是同步非阻塞的。” “NIO 有三大组件：Channel、Buffer、Selector。” “NIO 性能比 BIO 好。” 但如果继续追问：“为什么非阻塞就快？Selector 到底是个什么东西？它和操作系统的 epoll 有什么关系？”很多人可能就卡壳了。 今天我们就从操作系统的底层模型出发，来聊聊 Java NIO 的前世今生，以及为什么我说它是 IO 模型的“Pro Max”版。 1. 痛点：BIO 时代的“贵族服务”在 JDK 1.4 之前，我们使用的是 BIO（Blocking I/O，阻塞 IO）。BIO 的编程模型非常简单符合直觉：建立连接 -&gt; 读数据 -&gt; 写数据。 但是它有一个致命的弱点：阻塞。就像一个传统的餐厅，每一桌客人（Socket 连接）必须配备一名专属服务员（Thread）。 客人看菜单（数据未就绪...</div></div></div></a><a class="pagination-related" href="/posts/4b1bdc5.html" title="Kafka为什么这么快"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-02-07</div><div class="info-item-2">Kafka为什么这么快</div></div><div class="info-2"><div class="info-item-1">深度解析：为什么 Kafka 能快到“突破天际”？—— 论 Kafka 的机械共鸣设计在分布式系统领域，Apache Kafka 几乎是高性能消息队列的代名词。令人惊叹的是，作为一个基于磁盘存储的系统，Kafka 的吞吐量竟然能超越许多基于内存的数据库。 很多人将其归结为“快”，但这种快并不是某种单一的黑科技，而是一场对硬件特性的极致压榨。这种设计思想在计算机科学中被称为 “机械共鸣” —— 即了解底层硬件的工作原理，并让软件设计顺应这些原理。 本文将从五个核心维度，拆解 Kafka 性能神话背后的技术思考。 一、 颠覆认知：磁盘并不慢，随机读写才慢很多人对 Kafka 的第一个疑问是：“数据存磁盘上，怎么可能快？” 事实上，磁盘的顺序写（Sequential Writing）性能极高。在某些场景下，磁盘顺序写的速度甚至可以媲美随机内存读写。 Kafka 的做法：Kafka 将所有消息以 Append-only（仅追加） 的方式写入日志文件（Log）。它不执行任何随机位置的更新，也不删除单条数据。 技术思考：通过将“逻辑上的随机写”转换为“物理上的顺序写”，Kafka 绕过了...</div></div></div></a><a class="pagination-related" href="/posts/fee9ca7b.html" title="分布式事务相关的总结"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-15</div><div class="info-item-2">分布式事务相关的总结</div></div><div class="info-2"><div class="info-item-1">分布式事务TC 如何知道哪些RM属于同一个全局事务？以Seate框架为例，在TM向TC发送全局事务开始时，TC会生成对应的全局事务ID（XID），并发送给TM。TM 将 XID 放入当前线程的 ThreadLocal 中，后续的 RM (资源管理器) 分支事务通过解析该 XID 来注册分支。如果涉及RPC调用，每次调用时会在请求头部传递这个XID，让RM知道这个XID,RM向TC发送分支事务开始时,就会携带这个XID,从而告诉TC这个RM属于哪一个全局事务。 在多线程中，由于每个线程的XID是线程私有的，所以无法确定哪些RM属于同一个全局事务。这时全局事务会失效。解决方案可以是在开启新线程时，将XID传递给新线程，新线程的XID会继承父线程的XID。这样子线程的XID就会和父线程的XID一致，从而可以确定哪些RM属于同一个全局事务。 流程图片</div></div></div></a><a class="pagination-related" href="/posts/34e1e2ae.html" title="并发与串行下的接口幂等"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-02-21</div><div class="info-item-2">并发与串行下的接口幂等</div></div><div class="info-2"><div class="info-item-1">架构漫谈：别让分布式锁成“背锅侠”——接口幂等性的深度思考与实践在分布式系统的开发中，“接口幂等性（Idempotency）”是一个老生常谈却又极易踩坑的话题。尤其是涉及资金交易、订单状态流转的业务（如提现、转账、支付），一旦防重逻辑出现漏洞，轻则客诉，重则产生直接资损。 很多开发者在面对“重复请求”时，第一反应往往是：“加个 Redis 分布式锁不就行了吗？” 然而，在经历过几次血淋淋的生产事故后，你会发现：光靠分布式锁，根本拦不住真正的重复执行。 今天，我们就来深度剖析一下，为什么分布式锁不能和幂等画等号，以及在企业级架构中，究竟该如何构建一道坚不可摧的幂等防线。 1. 灾难现场：被击穿的“加锁”逻辑假设我们有一个“异步出款（提现）”的消费者（Kafka Consumer）。由于网络抖动，Kafka 发生了消息积压或超时重发，导致同一笔订单的出款消息被消费了两次。 小白开发者的防御代码往往是这样写的： 12345678910111213// 反面教材：单纯加锁public void processPayout(String orderId) &#123; if (r...</div></div></div></a><a class="pagination-related" href="/posts/a3a5550f.html" title="计算机网络问题总结"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-08</div><div class="info-item-2">计算机网络问题总结</div></div><div class="info-2"><div class="info-item-1">学习过程中的疑惑通过ARP协议我们可以知道目的ip的mac地址 那要是这个ip不在我的局域网里面 那我应该得到谁的mac地址呢这是一个非常经典且关键的网络问题。 简单直接的回答是：你会得到你所在局域网的“网关”（Gateway）的 MAC 地址。 详细原理解析当你的电脑（主机 A）想要发送数据包给一个 IP 地址（主机 B）时，它会经历以下逻辑判断流程： 判断目标 IP 是否在同一个局域网（子网）内： 电脑会查看自己的子网掩码（Subnet Mask）。 如果 目标IP 和 本机IP 在同一个网段内，电脑认为它可以直接通信。 如果不在同一个网段内，电脑认为“我够不着它”，必须找一个“中介”来帮忙转发。 寻找“中介”（网关）： 这个“中介”就是你配置的默认网关（Default Gateway）。通常这是你路由器（Router）的内网 IP 地址（例如 192.168.1.1 或 192.168.0.1）。 电脑会把数据包发给网关，由网关负责把数据包投递到外网。 ARP 解析的对象发生变化： 既然数据包要发给网关，那么在数据链路层（二层），目标 MAC 地址就必须是...</div></div></div></a></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/666.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info-name">纳斯卡可</div><div class="author-info-description">纳斯卡可的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">48</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/rolay-nmcb"><i class="fab fa-github"></i><span>Follow Me<i class="faa-passing animated" style="padding-left:20px;display:inline-block;vertical-align:middle"><svg class="icon" style="height:28px;width:28px;fill:currentColor;position:relative;top:5px"><use xlink:href="#icon-car"></use></svg></i></span></a><div class="card-info-social-icons"><a class="social-icon faa-parent animated-hover" href="https://github.com/rolay-nmcb" target="_blank" title="Github"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gitHub"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=2843035026@qq.com" target="_blank" title="Email"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-youxiang"></use></svg></a><a class="social-icon faa-parent animated-hover" href="/atom.xml" target="_blank" title="RSS"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-rss"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1949615496" target="_blank" title="BiliBili"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-bilibili1"></use></svg></a><a class="social-icon faa-parent animated-hover" href="tencent://Message/?Uin=2843035026&amp;amp;websiteName=local.edu.com:8888=&amp;amp;Menu=yes" target="_blank" title="QQ"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-QQ1"></use></svg></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">我的博客上线了🎉🎉🎉</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90-Kafka-%E5%A4%9A%E5%89%AF%E6%9C%AC%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6%EF%BC%9A%E4%BB%8E-HW-%E5%88%B0-Leader-Epoch"><span class="toc-number">1.</span> <span class="toc-text">深度解析 Kafka 多副本同步机制：从 HW 到 Leader Epoch</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81-%E6%A0%B8%E5%BF%83%E8%A7%92%E8%89%B2%E4%B8%8E%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">一、 核心角色与概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81-%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%85%A8%E8%BF%87%E7%A8%8B%EF%BC%9AHW-%E7%9A%84%E5%8A%A8%E6%80%81%E6%BC%94%E8%BF%9B"><span class="toc-number">1.2.</span> <span class="toc-text">二、 数据同步全过程：HW 的动态演进</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9AFollower-%E6%8B%89%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 第一步：Follower 拉取数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9ALeader-%E6%9B%B4%E6%96%B0-LEO-%E4%B8%8E-HW"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 第二步：Leader 更新 LEO 与 HW</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9AFollower-%E6%9B%B4%E6%96%B0-HW"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. 第三步：Follower 更新 HW</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81-HW-%E6%9C%BA%E5%88%B6%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-Leader-Epoch%EF%BC%9F"><span class="toc-number">1.3.</span> <span class="toc-text">三、 HW 机制的局限性：为什么需要 Leader Epoch？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Leader-Epoch-%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.1.</span> <span class="toc-text">Leader Epoch 机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81-%E6%80%BB%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">四、 总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/34e1e2ae.html" title="并发与串行下的接口幂等">并发与串行下的接口幂等</a><time datetime="2026-02-21T12:41:31.000Z" title="发表于 2026-02-21 12:41:31">2026-02-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/10b4eaf1.html" title="Kafka的多副本同步机制">Kafka的多副本同步机制</a><time datetime="2026-02-16T17:22:19.000Z" title="发表于 2026-02-16 17:22:19">2026-02-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/ae7d08b8.html" title="在DDD下怎么高效实现一人一单+库存超卖">在DDD下怎么高效实现一人一单+库存超卖</a><time datetime="2026-02-11T14:22:55.000Z" title="发表于 2026-02-11 14:22:55">2026-02-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/95975943.html" title="算法（十六） 区间DP">算法（十六） 区间DP</a><time datetime="2026-02-07T13:37:09.000Z" title="发表于 2026-02-07 13:37:09">2026-02-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/4b1bdc5.html" title="Kafka为什么这么快">Kafka为什么这么快</a><time datetime="2026-02-07T13:32:58.000Z" title="发表于 2026-02-07 13:32:58">2026-02-07</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By 纳斯卡可</span><span class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.0</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdmirror.com/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.nmcb666.vip/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://twikoo.nmcb666.vip/',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdmirror.com/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><div class="aplayer no-destroy" data-id="2827597264" data-server="netease" data-type="playlist" data-order="list" data-fixed="true" data-preload="auto" data-autoplay="false" data-mutex="true"></div><script defer src="/js/cursor.js"></script><canvas id="universe"></canvas><script src="/bilibiliBanner/banner.js" defer></script><script defer src="/js/universe.js"></script><link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/aplayer/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdmirror.com/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdmirror.com/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><div class="app-refresh" id="app-refresh" style="position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease"><div class="app-refresh-wrap" style="display:flex;color:#fff;height:100%;align-items:center;justify-content:center"><label>✨ 有新文章啦！ 👉</label><a href="javascript:void(0)" onclick="location.reload()"><span style="color:#fff;text-decoration:underline;cursor:pointer">🍗点击食用🍔</span></a></div></div><script>if ('serviceWorker' in navigator) {
if (navigator.serviceWorker.controller) {
navigator.serviceWorker.addEventListener('controllerchange', function() {
showNotification()
})
}
window.addEventListener('load', function() {
navigator.serviceWorker.register('/sw.js')
})
}
function showNotification() {
if (GLOBAL_CONFIG.Snackbar) {
var snackbarBg =
document.documentElement.getAttribute('data-theme') === 'light' ?
GLOBAL_CONFIG.Snackbar.bgLight :
GLOBAL_CONFIG.Snackbar.bgDark
var snackbarPos = GLOBAL_CONFIG.Snackbar.position
Snackbar.show({
text: '✨ 有新文章啦！ 👉',
backgroundColor: snackbarBg,
duration: 500000,
pos: snackbarPos,
actionText: '🍗点击食用🍔',
actionTextColor: '#fff',
onActionClick: function(e) {
location.reload()
},
})
} else {
var showBg =
document.documentElement.getAttribute('data-theme') === 'light' ?
'#3b70fc' :
'#1f1f1f'
var cssText = `top: 0; background: ${showBg};`
document.getElementById('app-refresh').style.cssText = cssText
}
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"></div><hr><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><script data-pjax>function butterfly_clock_anzhiyu_injector_config(){var a=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载butterfly_clock_anzhiyu-yang修复版"),a&&a.insertAdjacentHTML("afterbegin",'<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",qweather_key="b16a1fa0e63c46a4b8f28abfb06ae3fe",gaud_map_key="f54ba5c7880f35d1311b742bbbd52988",baidu_ak_key="undefined",flag=0,clock_rectangle="112.982279,28.19409",clock_default_rectangle_enable="false",i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;"all"===epage&&0==flag?butterfly_clock_anzhiyu_injector_config():epage===cpage&&butterfly_clock_anzhiyu_injector_config()</script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax>function butterfly_footer_beautify_injector_config(){var A=document.getElementById("footer");console.log("已挂载butterfly_footer_beautify"),A.insertAdjacentHTML("beforeend",'<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title=""><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v4.2.2" title=""><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://cdn.jsdmirror.com/" style="margin-inline:5px" data-title="本站使用jsdmirror为静态资源提供CDN加速" title=""><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsdmirror" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;"all"===epage&&0==flag?butterfly_footer_beautify_injector_config():epage===cpage&&butterfly_footer_beautify_injector_config()</script><script async src="/js/runtime.js"></script><script async src="/js/ali_font.js"></script><div class="js-pjax"><script async>for(var arr=document.getElementsByClassName("recent-post-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration","1.5s"),arr[i].setAttribute("data-wow-delay","200ms"),arr[i].setAttribute("data-wow-offset","30"),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("card-widget"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration",""),arr[i].setAttribute("data-wow-delay","200ms"),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("flink-list-card"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__flipInY"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("flink-list-card"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__animated"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("article-sort-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__slideInRight"),arr[i].setAttribute("data-wow-duration","1.5s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("site-card"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__flipInY"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("site-card"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__animated"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script></div><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://unpkg.com/oh-my-live2d"></script><script>const oml2d = OML2D.loadOml2d({dockedPosition:"right",mobileDisplay:true,models:[{"path":"https://cdn.jsdmirror.com/gh/rolay-nmcb/my-live2d/LSS.model3.json","mobilePosition":[20,0],"mobileScale":0.15,"mobileStageStyle":{"width":130,"height":130},"motionPreloadStrategy":"IDLE","position":[15,0],"scale":0.25,"stageStyle":{"width":250,"height":250}},{"path":"https://cdn.jsdmirror.com/gh/rolay-nmcb/my-live2d@main/boqi/yili.model3.json","mobilePosition":[-20,5],"mobileScale":0.1,"mobileStageStyle":{"width":130,"height":130},"motionPreloadStrategy":"IDLE","position":[-50,0],"scale":0.2,"stageStyle":{"width":250,"height":250}},{"path":"https://cdn.jsdmirror.com/gh/rolay-nmcb/my-live2d@main/congyu/Murasame.model3.json","mobilePosition":[10,0],"mobileScale":0.1,"mobileStageStyle":{"width":130,"height":130},"motionPreloadStrategy":"IDLE","position":[20,40],"scale":0.15,"stageStyle":{"width":250,"height":300}},{"path":"https://cdn.jsdmirror.com/gh/rolay-nmcb/my-live2d@main/Motis/Motis.model3.json","mobilePosition":[-20,-15],"mobileScale":0.1,"mobileStageStyle":{"width":130,"height":165},"motionPreloadStrategy":"IDLE","position":[-25,-20],"scale":0.15,"stageStyle":{"width":250,"height":250}}],parentElement:document.body,primaryColor:"var(--btn-bg)",sayHello:false,tips:{style: {"width":180,"height":100,"left":"calc(50% - 20px)","top":"-100px"},mobileStyle: {"width":150,"height":70,"left":"calc(50% - 30px)","top":"-80px"},copyTips: {"message":["复制记得注明出处哦~"]},idleTips:{interval:60000,message:["你好呀~","欢迎来到我的小站~"]}}});</script></body></html>