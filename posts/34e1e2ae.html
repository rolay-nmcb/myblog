<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>并发与串行下的接口幂等 | 纳斯卡可`Blog</title><meta name="author" content="纳斯卡可,2843035026@qq.com"><meta name="copyright" content="纳斯卡可"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="架构漫谈：别让分布式锁成“背锅侠”——接口幂等性的深度思考与实践在分布式系统的开发中，“接口幂等性（Idempotency）”是一个老生常谈却又极易踩坑的话题。尤其是涉及资金交易、订单状态流转的业务（如提现、转账、支付），一旦防重逻辑出现漏洞，轻则客诉，重则产生直接资损。 很多开发者在面对“重复请求”时，第一反应往往是：“加个 Redis 分布式锁不就行了吗？”  然而，在经历过几次血淋淋的生产事"><meta property="og:type" content="article"><meta property="og:title" content="并发与串行下的接口幂等"><meta property="og:url" content="https://nmcb666.vip/posts/34e1e2ae.html"><meta property="og:site_name" content="纳斯卡可&#96;Blog"><meta property="og:description" content="架构漫谈：别让分布式锁成“背锅侠”——接口幂等性的深度思考与实践在分布式系统的开发中，“接口幂等性（Idempotency）”是一个老生常谈却又极易踩坑的话题。尤其是涉及资金交易、订单状态流转的业务（如提现、转账、支付），一旦防重逻辑出现漏洞，轻则客诉，重则产生直接资损。 很多开发者在面对“重复请求”时，第一反应往往是：“加个 Redis 分布式锁不就行了吗？”  然而，在经历过几次血淋淋的生产事"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/666.jpg"><meta property="article:published_time" content="2026-02-21T12:41:31.000Z"><meta property="article:modified_time" content="2026-02-21T04:46:00.812Z"><meta property="article:author" content="纳斯卡可"><meta property="article:tag" content="八股"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/666.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "并发与串行下的接口幂等",
  "url": "https://nmcb666.vip/posts/34e1e2ae.html",
  "image": "https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/666.jpg",
  "datePublished": "2026-02-21T12:41:31.000Z",
  "dateModified": "2026-02-21T04:46:00.812Z",
  "author": [
    {
      "@type": "Person",
      "name": "纳斯卡可",
      "url": "https://nmcb666.vip"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://nmcb666.vip/posts/34e1e2ae.html"><link rel="preconnect" href="//cdn.jsdmirror.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#13227a"><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/128.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"><link rel="mask-icon" href="/img/siteicon/128.png" color="#5bbad5"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>(() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"pagination":{"enable":false,"hitsPerPage":8},"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdmirror.com/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"并发与串行下的接口幂等",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload='this.media="all"'><script defer src="/js/title.js"></script><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/bilibiliBanner/banner.css"><link rel="stylesheet" href="https://cdn.jsdmirror.com/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/css/runtime/runtime.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload='this.media="all"'><script src="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload='this.media="screen"'><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="纳斯卡可`Blog" type="application/atom+xml"></head><body><div id="web_bg" style="background-image:url(https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/default_cover_14.webp)"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/666.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">48</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-home"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-home"></use></svg> <span>Home</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-archive"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-archive"></use></svg> <span>归档</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="fa-fw icon-tags"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg> <span>标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/bangumis/index.html"><i class="fa-fw icon-bilibili"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-bilibili"></use></svg> <span>追番</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-xinfeng"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xinfeng"></use></svg> <span>留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/links/"><i class="fa-fw icon-lianjie"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg> <span>友链</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-zhifeiji"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zhifeiji"></use></svg> <span>关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">纳斯卡可`Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">并发与串行下的接口幂等</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i> <span>返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-home"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-home"></use></svg> <span>Home</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-archive"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-archive"></use></svg> <span>归档</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="fa-fw icon-tags"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tags"></use></svg> <span>标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/bangumis/index.html"><i class="fa-fw icon-bilibili"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-bilibili"></use></svg> <span>追番</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-xinfeng"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xinfeng"></use></svg> <span>留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/links/"><i class="fa-fw icon-lianjie"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-lianjie"></use></svg> <span>友链</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-zhifeiji"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zhifeiji"></use></svg> <span>关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">并发与串行下的接口幂等</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2026-02-21T12:41:31.000Z" title="发表于 2026-02-21 12:41:31">2026-02-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-02-21T04:46:00.812Z" title="更新于 2026-02-21 04:46:00">2026-02-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="架构漫谈：别让分布式锁成“背锅侠”——接口幂等性的深度思考与实践"><a href="#架构漫谈：别让分布式锁成“背锅侠”——接口幂等性的深度思考与实践" class="headerlink" title="架构漫谈：别让分布式锁成“背锅侠”——接口幂等性的深度思考与实践"></a>架构漫谈：别让分布式锁成“背锅侠”——接口幂等性的深度思考与实践</h1><p>在分布式系统的开发中，<strong>“接口幂等性（Idempotency）”</strong>是一个老生常谈却又极易踩坑的话题。尤其是涉及资金交易、订单状态流转的业务（如提现、转账、支付），一旦防重逻辑出现漏洞，轻则客诉，重则产生直接资损。</p><p>很多开发者在面对“重复请求”时，第一反应往往是：“<strong>加个 Redis 分布式锁不就行了吗？</strong>”</p><p>然而，在经历过几次血淋淋的生产事故后，你会发现：<strong>光靠分布式锁，根本拦不住真正的重复执行。</strong></p><p>今天，我们就来深度剖析一下，为什么分布式锁不能和幂等画等号，以及在企业级架构中，究竟该如何构建一道坚不可摧的幂等防线。</p><hr><h2 id="1-灾难现场：被击穿的“加锁”逻辑"><a href="#1-灾难现场：被击穿的“加锁”逻辑" class="headerlink" title="1. 灾难现场：被击穿的“加锁”逻辑"></a>1. 灾难现场：被击穿的“加锁”逻辑</h2><p>假设我们有一个“异步出款（提现）”的消费者（Kafka Consumer）。由于网络抖动，Kafka 发生了消息积压或超时重发，导致同一笔订单的出款消息被消费了两次。</p><p>小白开发者的防御代码往往是这样写的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 反面教材：单纯加锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processPayout</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (redisLock.tryLock(<span class="string">&quot;lock:payout:&quot;</span> + orderId)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 调用银行接口打款</span></span><br><span class="line">            bankService.pay(orderId, amount);</span><br><span class="line">            <span class="comment">// 2. 更新订单状态为成功</span></span><br><span class="line">            orderService.updateStatus(orderId, <span class="string">&quot;SUCCESS&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock(); <span class="comment">// 释放锁</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>漏洞在哪里？</strong><br>当第一条消息正常执行完毕，<strong>锁被释放了</strong>。此时，重发的第二条消息姗姗来迟。它兴冲冲地去 Redis 拿锁，发现锁是空闲的！于是它顺利拿到锁，<strong>再次调用了银行接口，导致同一笔订单被打了两次钱</strong>。</p><p>这里暴露了一个核心认知误区：<strong>分布式锁只能解决“拥挤”问题，无法解决“健忘”问题。</strong></p><hr><h2 id="2-核心洞察：防并发重复-vs-防串行重复"><a href="#2-核心洞察：防并发重复-vs-防串行重复" class="headerlink" title="2. 核心洞察：防并发重复 vs 防串行重复"></a>2. 核心洞察：防并发重复 vs 防串行重复</h2><p>之前看过一句非常精辟的话：</p><blockquote><p><strong>“加锁是防止并发重复，唯一索引或状态机流转是防止串行重复。”</strong></p></blockquote><p>这句话彻底点透了幂等设计的本质。我们可以用一个<strong>“进屋开灯”</strong>的模型来具象化这个概念：</p><ul><li><strong>并发重复（两个人同时冲进房间要开灯）：</strong><br>此时你需要的是一把<strong>“门锁”（分布式锁）</strong>。它的作用是把一拥而上的请求变成排队进屋的串行请求。保证同一时刻，只有一个人能站在开关面前。</li><li><strong>串行重复（A进屋开完灯走了，B随后又进屋了）：</strong><br>此时光有门锁没用（因为A已经把锁还了）。你需要的是<strong>“状态检查”（状态机）</strong>或者墙上的<strong>“开灯记录表”（唯一索引）</strong>。B 进屋后，必须先看一眼灯是不是已经亮了，或者看看记录本上是不是写着“已开灯”。如果已经是处理过的状态，就直接转身离开。</li></ul><p><strong>结论：真正的幂等 = 防并发（锁） + 防串行（状态检查/唯一记录）。</strong></p><hr><h2 id="3-企业级幂等方案演进"><a href="#3-企业级幂等方案演进" class="headerlink" title="3. 企业级幂等方案演进"></a>3. 企业级幂等方案演进</h2><p>理解了本质，我们来看看在实际业务中，如何组合使用这套逻辑。</p><h3 id="方案一：标准组合拳（分布式锁-状态机-Check-and-Act）"><a href="#方案一：标准组合拳（分布式锁-状态机-Check-and-Act）" class="headerlink" title="方案一：标准组合拳（分布式锁 + 状态机 Check-and-Act）"></a>方案一：标准组合拳（分布式锁 + 状态机 Check-and-Act）</h3><p>这是绝大多数非高并发资金业务的最佳实践。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正确示范：锁 + 状态机</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processPayout</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 加锁（防并发）</span></span><br><span class="line">    <span class="keyword">if</span> (redisLock.tryLock(<span class="string">&quot;lock:payout:&quot;</span> + orderId)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2. 查状态（防串行重复，极其关键的一步！）</span></span><br><span class="line">            <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.getById(orderId);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">&quot;PROCESSING&quot;</span>.equals(order.getStatus())) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;订单 &#123;&#125; 状态非处理中，幂等返回&quot;</span>, orderId);</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// 已经处理过了，直接返回</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 执行核心业务</span></span><br><span class="line">            bankService.pay(orderId, amount);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4. 推进状态机</span></span><br><span class="line">            orderService.updateStatus(orderId, <span class="string">&quot;SUCCESS&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>优点：</strong> 逻辑清晰，能挡住 99% 的异常场景。<br><strong>隐患：</strong> 强依赖 Redis 锁和数据库状态的读取。如果 Redis 宕机导致锁失效，或者数据库主从延迟导致读到了旧状态（幻读），在极高并发下依然有极小概率被击穿。</p><h3 id="方案二：终极防线（数据库唯一索引去重表）"><a href="#方案二：终极防线（数据库唯一索引去重表）" class="headerlink" title="方案二：终极防线（数据库唯一索引去重表）"></a>方案二：终极防线（数据库唯一索引去重表）</h3><p>对于涉及“资金出款”、“扣减库存”等绝对不能容忍重复的核心链路，我们需要祭出最强的物理防御：<strong>关系型数据库的唯一索引（Unique Constraint）</strong>。</p><p>巧妙的是，数据库的唯一索引<strong>天然同时具备了“防并发”和“防串行”的双重能力</strong>：</p><ul><li><strong>防并发：</strong> 数据库底层自带行级锁（或间隙锁），两个线程同时 Insert，必有一个被阻塞并抛出异常。</li><li><strong>防串行：</strong> 记录持久化在磁盘上，哪怕过了一年再来重试，依然会因为主键冲突而被拦截。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 终极示范：去重表/流水表</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processPayout</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 插入流水表（利用 unique_key(order_id)）</span></span><br><span class="line">        payoutRecordMapper.insert(<span class="keyword">new</span> <span class="title class_">PayoutRecord</span>(orderId, <span class="string">&quot;PENDING&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123;</span><br><span class="line">        <span class="comment">// 2. 捕获唯一键冲突，说明已经有人处理过了，直接幂等返回</span></span><br><span class="line">        log.warn(<span class="string">&quot;订单 &#123;&#125; 已存在出款流水，幂等拦截&quot;</span>, orderId);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 既然没抛异常，说明我是天选之子（唯一合法的请求）</span></span><br><span class="line">    <span class="comment">// 执行打款并更新状态</span></span><br><span class="line">    bankService.pay(orderId, amount);</span><br><span class="line">    orderService.updateStatus(orderId, <span class="string">&quot;SUCCESS&quot;</span>);</span><br><span class="line">    payoutRecordMapper.updateStatus(orderId, <span class="string">&quot;SUCCESS&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="4-架构师的抉择：如何优雅地结合？"><a href="#4-架构师的抉择：如何优雅地结合？" class="headerlink" title="4. 架构师的抉择：如何优雅地结合？"></a>4. 架构师的抉择：如何优雅地结合？</h2><p>在真实的千万级架构中，我们通常不会只用某一种，而是采用<strong>“前置缓存拦截 + 后置DB兜底”</strong>的组合策略。</p><ol><li><strong>第一道防线（Redis 分布式锁）：</strong><br>作为前锋，利用 Redis 的极高性能，将 90% 的并发重复请求和恶意重试挡在数据库之外，保护脆弱的 DB。</li><li><strong>第二道防线（DB 状态机乐观锁/唯一索引）：</strong><br>作为守门员，处理那些突破了 Redis（比如 Redis 瞬断、主从切换丢失锁）的漏网之鱼。只要数据库的 Unique Key 在，资金就不会多发一毛钱。</li></ol><h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>当你下次再面对接口幂等需求时，请在脑海里默念这三条军规：</p><ol><li><strong>分布式锁只管“排队”，不管“记忆”；</strong></li><li><strong>“查状态再执行（Check-and-Act）”必须包裹在锁（或事务）的保护之内；</strong></li><li><strong>涉及资金安全的底层防线，永远要交给数据库的唯一约束或乐观锁，不要迷信任何中间件。</strong></li></ol><p>不迷信框架，看透并发与串行的本质，才是构建高可用、高可靠系统的基石。</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者:</span> <span class="post-copyright-info"><a href="https://nmcb666.vip">纳斯卡可</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接:</span> <span class="post-copyright-info"><a href="https://nmcb666.vip/posts/34e1e2ae.html">https://nmcb666.vip/posts/34e1e2ae.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://nmcb666.vip" target="_blank">纳斯卡可`Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%85%AB%E8%82%A1/">八股</a></div><div class="post-share"><div class="social-share" data-image="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/666.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdmirror.com/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/wechat.jpg" alt="wechat"></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/posts/10b4eaf1.html" title="Kafka的多副本同步机制"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Kafka的多副本同步机制</div></div><div class="info-2"><div class="info-item-1">深度解析 Kafka 多副本同步机制：从 HW 到 Leader Epoch在分布式系统中，数据的一致性和高可用性永远是核心课题。Kafka 作为顶级消息流平台，其高可靠性主要依赖于多副本（Replication）机制。本文将带你深入底层，剖析 Kafka 副本之间是如何协同工作、确保数据不丢不重的。 一、 核心角色与概念在深入同步流程之前，我们先统一几个关键术语： Leader 副本：每个分区（Partition）在创建时，由 Controller 负责指派 Leader。Controller 会从 AR（Assigned Replicas，所有副本） 列表中找到第一个在 ISR 中的副本作为优先 Leader。所有的读写请求都由 Leader 处理。 Follower 副本：不处理客户端请求，只负责从 Leader 拉取（Pull）数据。 ISR (In-Sync Replicas)：与 Leader 保持同步的副本集合。判断标准是 replica.lag.time.max.ms（默认 30s），只要 Follower 在这个时间内向 Leader 发起过同步请求且进度没...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/6079905e.html" title="AQS是什么？"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-31</div><div class="info-item-2">AQS是什么？</div></div><div class="info-2"><div class="info-item-1">【Java并发】AQS详解：JUC包背后的“幕后大佬”在 Java 并发编程（JUC）的世界里，我们经常使用 ReentrantLock、CountDownLatch、Semaphore 这些赫赫有名的工具类。 但你是否想过，这些功能各异的工具背后，其实共用着同一套“底盘”？ 这就是我们今天要聊的主角——AQS (AbstractQueuedSynchronizer，抽象队列同步器)。它是 JUC 包的心脏，掌握了它，你就掌握了 Java 并发的半壁江山。 一、 什么是 AQS？AQS 是一个用于构建锁和同步器的框架。 如果把 ReentrantLock、CountDownLatch 等比作是成品的汽车（跑车、卡车、公交车），那么 AQS 就是通用的汽车底盘和引擎。 AQS 负责脏活累活：它处理了线程的排队、阻塞、唤醒、线程安全等最复杂的底层逻辑。 同步器负责业务逻辑：具体的工具类只需要告诉 AQS，“什么时候算获取锁成功”，“资源一共有多少”，剩下的交给 AQS 即可。 简单来说，AQS 是一个“原材料”，我们可以根据它加工出各种各样的同步器。 二、 AQS 的核心架构AQ...</div></div></div></a><a class="pagination-related" href="/posts/9edb0695.html" title="Java中的NIO就是操作系统的同步非阻塞IO吗？"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-02-07</div><div class="info-item-2">Java中的NIO就是操作系统的同步非阻塞IO吗？</div></div><div class="info-2"><div class="info-item-1">Java NIO：不仅仅是“非阻塞”，更是 IO 模型的“Pro Max”在 Java 后端面试或高并发系统设计的讨论中，NIO (New I/O) 永远是一个绕不开的话题。 很多同学在初学时，往往会被教科书上的定义绕晕： “NIO 是同步非阻塞的。” “NIO 有三大组件：Channel、Buffer、Selector。” “NIO 性能比 BIO 好。” 但如果继续追问：“为什么非阻塞就快？Selector 到底是个什么东西？它和操作系统的 epoll 有什么关系？”很多人可能就卡壳了。 今天我们就从操作系统的底层模型出发，来聊聊 Java NIO 的前世今生，以及为什么我说它是 IO 模型的“Pro Max”版。 1. 痛点：BIO 时代的“贵族服务”在 JDK 1.4 之前，我们使用的是 BIO（Blocking I/O，阻塞 IO）。BIO 的编程模型非常简单符合直觉：建立连接 -&gt; 读数据 -&gt; 写数据。 但是它有一个致命的弱点：阻塞。就像一个传统的餐厅，每一桌客人（Socket 连接）必须配备一名专属服务员（Thread）。 客人看菜单（数据未就绪...</div></div></div></a><a class="pagination-related" href="/posts/4b1bdc5.html" title="Kafka为什么这么快"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-02-07</div><div class="info-item-2">Kafka为什么这么快</div></div><div class="info-2"><div class="info-item-1">深度解析：为什么 Kafka 能快到“突破天际”？—— 论 Kafka 的机械共鸣设计在分布式系统领域，Apache Kafka 几乎是高性能消息队列的代名词。令人惊叹的是，作为一个基于磁盘存储的系统，Kafka 的吞吐量竟然能超越许多基于内存的数据库。 很多人将其归结为“快”，但这种快并不是某种单一的黑科技，而是一场对硬件特性的极致压榨。这种设计思想在计算机科学中被称为 “机械共鸣” —— 即了解底层硬件的工作原理，并让软件设计顺应这些原理。 本文将从五个核心维度，拆解 Kafka 性能神话背后的技术思考。 一、 颠覆认知：磁盘并不慢，随机读写才慢很多人对 Kafka 的第一个疑问是：“数据存磁盘上，怎么可能快？” 事实上，磁盘的顺序写（Sequential Writing）性能极高。在某些场景下，磁盘顺序写的速度甚至可以媲美随机内存读写。 Kafka 的做法：Kafka 将所有消息以 Append-only（仅追加） 的方式写入日志文件（Log）。它不执行任何随机位置的更新，也不删除单条数据。 技术思考：通过将“逻辑上的随机写”转换为“物理上的顺序写”，Kafka 绕过了...</div></div></div></a><a class="pagination-related" href="/posts/10b4eaf1.html" title="Kafka的多副本同步机制"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-02-16</div><div class="info-item-2">Kafka的多副本同步机制</div></div><div class="info-2"><div class="info-item-1">深度解析 Kafka 多副本同步机制：从 HW 到 Leader Epoch在分布式系统中，数据的一致性和高可用性永远是核心课题。Kafka 作为顶级消息流平台，其高可靠性主要依赖于多副本（Replication）机制。本文将带你深入底层，剖析 Kafka 副本之间是如何协同工作、确保数据不丢不重的。 一、 核心角色与概念在深入同步流程之前，我们先统一几个关键术语： Leader 副本：每个分区（Partition）在创建时，由 Controller 负责指派 Leader。Controller 会从 AR（Assigned Replicas，所有副本） 列表中找到第一个在 ISR 中的副本作为优先 Leader。所有的读写请求都由 Leader 处理。 Follower 副本：不处理客户端请求，只负责从 Leader 拉取（Pull）数据。 ISR (In-Sync Replicas)：与 Leader 保持同步的副本集合。判断标准是 replica.lag.time.max.ms（默认 30s），只要 Follower 在这个时间内向 Leader 发起过同步请求且进度没...</div></div></div></a><a class="pagination-related" href="/posts/fee9ca7b.html" title="分布式事务相关的总结"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-15</div><div class="info-item-2">分布式事务相关的总结</div></div><div class="info-2"><div class="info-item-1">分布式事务TC 如何知道哪些RM属于同一个全局事务？以Seate框架为例，在TM向TC发送全局事务开始时，TC会生成对应的全局事务ID（XID），并发送给TM。TM 将 XID 放入当前线程的 ThreadLocal 中，后续的 RM (资源管理器) 分支事务通过解析该 XID 来注册分支。如果涉及RPC调用，每次调用时会在请求头部传递这个XID，让RM知道这个XID,RM向TC发送分支事务开始时,就会携带这个XID,从而告诉TC这个RM属于哪一个全局事务。 在多线程中，由于每个线程的XID是线程私有的，所以无法确定哪些RM属于同一个全局事务。这时全局事务会失效。解决方案可以是在开启新线程时，将XID传递给新线程，新线程的XID会继承父线程的XID。这样子线程的XID就会和父线程的XID一致，从而可以确定哪些RM属于同一个全局事务。 流程图片</div></div></div></a><a class="pagination-related" href="/posts/a3a5550f.html" title="计算机网络问题总结"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2026-01-08</div><div class="info-item-2">计算机网络问题总结</div></div><div class="info-2"><div class="info-item-1">学习过程中的疑惑通过ARP协议我们可以知道目的ip的mac地址 那要是这个ip不在我的局域网里面 那我应该得到谁的mac地址呢这是一个非常经典且关键的网络问题。 简单直接的回答是：你会得到你所在局域网的“网关”（Gateway）的 MAC 地址。 详细原理解析当你的电脑（主机 A）想要发送数据包给一个 IP 地址（主机 B）时，它会经历以下逻辑判断流程： 判断目标 IP 是否在同一个局域网（子网）内： 电脑会查看自己的子网掩码（Subnet Mask）。 如果 目标IP 和 本机IP 在同一个网段内，电脑认为它可以直接通信。 如果不在同一个网段内，电脑认为“我够不着它”，必须找一个“中介”来帮忙转发。 寻找“中介”（网关）： 这个“中介”就是你配置的默认网关（Default Gateway）。通常这是你路由器（Router）的内网 IP 地址（例如 192.168.1.1 或 192.168.0.1）。 电脑会把数据包发给网关，由网关负责把数据包投递到外网。 ARP 解析的对象发生变化： 既然数据包要发给网关，那么在数据链路层（二层），目标 MAC 地址就必须是...</div></div></div></a></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://java-ai-nskk.oss-cn-beijing.aliyuncs.com/myblog/666.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info-name">纳斯卡可</div><div class="author-info-description">纳斯卡可的博客</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">48</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/rolay-nmcb"><i class="fab fa-github"></i><span>Follow Me<i class="faa-passing animated" style="padding-left:20px;display:inline-block;vertical-align:middle"><svg class="icon" style="height:28px;width:28px;fill:currentColor;position:relative;top:5px"><use xlink:href="#icon-car"></use></svg></i></span></a><div class="card-info-social-icons"><a class="social-icon faa-parent animated-hover" href="https://github.com/rolay-nmcb" target="_blank" title="Github"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gitHub"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=2843035026@qq.com" target="_blank" title="Email"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-youxiang"></use></svg></a><a class="social-icon faa-parent animated-hover" href="/atom.xml" target="_blank" title="RSS"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-rss"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1949615496" target="_blank" title="BiliBili"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-bilibili1"></use></svg></a><a class="social-icon faa-parent animated-hover" href="tencent://Message/?Uin=2843035026&amp;amp;websiteName=local.edu.com:8888=&amp;amp;Menu=yes" target="_blank" title="QQ"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-QQ1"></use></svg></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">我的博客上线了🎉🎉🎉</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E6%BC%AB%E8%B0%88%EF%BC%9A%E5%88%AB%E8%AE%A9%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E6%88%90%E2%80%9C%E8%83%8C%E9%94%85%E4%BE%A0%E2%80%9D%E2%80%94%E2%80%94%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%89%E6%80%A7%E7%9A%84%E6%B7%B1%E5%BA%A6%E6%80%9D%E8%80%83%E4%B8%8E%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.</span> <span class="toc-text">架构漫谈：别让分布式锁成“背锅侠”——接口幂等性的深度思考与实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%81%BE%E9%9A%BE%E7%8E%B0%E5%9C%BA%EF%BC%9A%E8%A2%AB%E5%87%BB%E7%A9%BF%E7%9A%84%E2%80%9C%E5%8A%A0%E9%94%81%E2%80%9D%E9%80%BB%E8%BE%91"><span class="toc-number">1.1.</span> <span class="toc-text">1. 灾难现场：被击穿的“加锁”逻辑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%A0%B8%E5%BF%83%E6%B4%9E%E5%AF%9F%EF%BC%9A%E9%98%B2%E5%B9%B6%E5%8F%91%E9%87%8D%E5%A4%8D-vs-%E9%98%B2%E4%B8%B2%E8%A1%8C%E9%87%8D%E5%A4%8D"><span class="toc-number">1.2.</span> <span class="toc-text">2. 核心洞察：防并发重复 vs 防串行重复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%B9%82%E7%AD%89%E6%96%B9%E6%A1%88%E6%BC%94%E8%BF%9B"><span class="toc-number">1.3.</span> <span class="toc-text">3. 企业级幂等方案演进</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A%E6%A0%87%E5%87%86%E7%BB%84%E5%90%88%E6%8B%B3%EF%BC%88%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-%E7%8A%B6%E6%80%81%E6%9C%BA-Check-and-Act%EF%BC%89"><span class="toc-number">1.3.1.</span> <span class="toc-text">方案一：标准组合拳（分布式锁 + 状态机 Check-and-Act）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E7%BB%88%E6%9E%81%E9%98%B2%E7%BA%BF%EF%BC%88%E6%95%B0%E6%8D%AE%E5%BA%93%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95%E5%8E%BB%E9%87%8D%E8%A1%A8%EF%BC%89"><span class="toc-number">1.3.2.</span> <span class="toc-text">方案二：终极防线（数据库唯一索引去重表）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9E%B6%E6%9E%84%E5%B8%88%E7%9A%84%E6%8A%89%E6%8B%A9%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E5%9C%B0%E7%BB%93%E5%90%88%EF%BC%9F"><span class="toc-number">1.4.</span> <span class="toc-text">4. 架构师的抉择：如何优雅地结合？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.</span> <span class="toc-text">5. 总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/34e1e2ae.html" title="并发与串行下的接口幂等">并发与串行下的接口幂等</a><time datetime="2026-02-21T12:41:31.000Z" title="发表于 2026-02-21 12:41:31">2026-02-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/10b4eaf1.html" title="Kafka的多副本同步机制">Kafka的多副本同步机制</a><time datetime="2026-02-16T17:22:19.000Z" title="发表于 2026-02-16 17:22:19">2026-02-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/ae7d08b8.html" title="在DDD下怎么高效实现一人一单+库存超卖">在DDD下怎么高效实现一人一单+库存超卖</a><time datetime="2026-02-11T14:22:55.000Z" title="发表于 2026-02-11 14:22:55">2026-02-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/95975943.html" title="算法（十六） 区间DP">算法（十六） 区间DP</a><time datetime="2026-02-07T13:37:09.000Z" title="发表于 2026-02-07 13:37:09">2026-02-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/4b1bdc5.html" title="Kafka为什么这么快">Kafka为什么这么快</a><time datetime="2026-02-07T13:32:58.000Z" title="发表于 2026-02-07 13:32:58">2026-02-07</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By 纳斯卡可</span><span class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.0</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdmirror.com/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.nmcb666.vip/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://twikoo.nmcb666.vip/',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdmirror.com/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><div class="aplayer no-destroy" data-id="2827597264" data-server="netease" data-type="playlist" data-order="list" data-fixed="true" data-preload="auto" data-autoplay="false" data-mutex="true"></div><script defer src="/js/cursor.js"></script><canvas id="universe"></canvas><script src="/bilibiliBanner/banner.js" defer></script><script defer src="/js/universe.js"></script><link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/aplayer/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdmirror.com/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdmirror.com/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><div class="app-refresh" id="app-refresh" style="position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease"><div class="app-refresh-wrap" style="display:flex;color:#fff;height:100%;align-items:center;justify-content:center"><label>✨ 有新文章啦！ 👉</label><a href="javascript:void(0)" onclick="location.reload()"><span style="color:#fff;text-decoration:underline;cursor:pointer">🍗点击食用🍔</span></a></div></div><script>if ('serviceWorker' in navigator) {
if (navigator.serviceWorker.controller) {
navigator.serviceWorker.addEventListener('controllerchange', function() {
showNotification()
})
}
window.addEventListener('load', function() {
navigator.serviceWorker.register('/sw.js')
})
}
function showNotification() {
if (GLOBAL_CONFIG.Snackbar) {
var snackbarBg =
document.documentElement.getAttribute('data-theme') === 'light' ?
GLOBAL_CONFIG.Snackbar.bgLight :
GLOBAL_CONFIG.Snackbar.bgDark
var snackbarPos = GLOBAL_CONFIG.Snackbar.position
Snackbar.show({
text: '✨ 有新文章啦！ 👉',
backgroundColor: snackbarBg,
duration: 500000,
pos: snackbarPos,
actionText: '🍗点击食用🍔',
actionTextColor: '#fff',
onActionClick: function(e) {
location.reload()
},
})
} else {
var showBg =
document.documentElement.getAttribute('data-theme') === 'light' ?
'#3b70fc' :
'#1f1f1f'
var cssText = `top: 0; background: ${showBg};`
document.getElementById('app-refresh').style.cssText = cssText
}
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><i class="fas fa-spinner fa-pulse" id="loading-status" hidden></i><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据加载中</span></div><div class="local-search-input"><input placeholder="搜索文章" type="text"></div><hr><div id="local-search-results"></div><div class="ais-Pagination" id="local-search-pagination" style="display:none"><ul class="ais-Pagination-list"></ul></div><div id="local-search-stats"></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><script data-pjax>function butterfly_clock_anzhiyu_injector_config(){var a=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载butterfly_clock_anzhiyu-yang修复版"),a&&a.insertAdjacentHTML("afterbegin",'<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",qweather_key="b16a1fa0e63c46a4b8f28abfb06ae3fe",gaud_map_key="f54ba5c7880f35d1311b742bbbd52988",baidu_ak_key="undefined",flag=0,clock_rectangle="112.982279,28.19409",clock_default_rectangle_enable="false",i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;"all"===epage&&0==flag?butterfly_clock_anzhiyu_injector_config():epage===cpage&&butterfly_clock_anzhiyu_injector_config()</script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax>function butterfly_footer_beautify_injector_config(){var A=document.getElementById("footer");console.log("已挂载butterfly_footer_beautify"),A.insertAdjacentHTML("beforeend",'<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title=""><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v4.2.2" title=""><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://cdn.jsdmirror.com/" style="margin-inline:5px" data-title="本站使用jsdmirror为静态资源提供CDN加速" title=""><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsdmirror" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;"all"===epage&&0==flag?butterfly_footer_beautify_injector_config():epage===cpage&&butterfly_footer_beautify_injector_config()</script><script async src="/js/runtime.js"></script><script async src="/js/ali_font.js"></script><div class="js-pjax"><script async>for(var arr=document.getElementsByClassName("recent-post-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration","1.5s"),arr[i].setAttribute("data-wow-delay","200ms"),arr[i].setAttribute("data-wow-offset","30"),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("card-widget"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration",""),arr[i].setAttribute("data-wow-delay","200ms"),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("flink-list-card"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__flipInY"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("flink-list-card"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__animated"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("article-sort-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__slideInRight"),arr[i].setAttribute("data-wow-duration","1.5s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("site-card"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__flipInY"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("site-card"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__animated"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script></div><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://unpkg.com/oh-my-live2d"></script><script>const oml2d = OML2D.loadOml2d({dockedPosition:"right",mobileDisplay:true,models:[{"path":"https://cdn.jsdmirror.com/gh/rolay-nmcb/my-live2d/LSS.model3.json","mobilePosition":[20,0],"mobileScale":0.15,"mobileStageStyle":{"width":130,"height":130},"motionPreloadStrategy":"IDLE","position":[15,0],"scale":0.25,"stageStyle":{"width":250,"height":250}},{"path":"https://cdn.jsdmirror.com/gh/rolay-nmcb/my-live2d@main/boqi/yili.model3.json","mobilePosition":[-20,5],"mobileScale":0.1,"mobileStageStyle":{"width":130,"height":130},"motionPreloadStrategy":"IDLE","position":[-50,0],"scale":0.2,"stageStyle":{"width":250,"height":250}},{"path":"https://cdn.jsdmirror.com/gh/rolay-nmcb/my-live2d@main/congyu/Murasame.model3.json","mobilePosition":[10,0],"mobileScale":0.1,"mobileStageStyle":{"width":130,"height":130},"motionPreloadStrategy":"IDLE","position":[20,40],"scale":0.15,"stageStyle":{"width":250,"height":300}},{"path":"https://cdn.jsdmirror.com/gh/rolay-nmcb/my-live2d@main/Motis/Motis.model3.json","mobilePosition":[-20,-15],"mobileScale":0.1,"mobileStageStyle":{"width":130,"height":165},"motionPreloadStrategy":"IDLE","position":[-25,-20],"scale":0.15,"stageStyle":{"width":250,"height":250}}],parentElement:document.body,primaryColor:"var(--btn-bg)",sayHello:false,tips:{style: {"width":180,"height":100,"left":"calc(50% - 20px)","top":"-100px"},mobileStyle: {"width":150,"height":70,"left":"calc(50% - 30px)","top":"-80px"},copyTips: {"message":["复制记得注明出处哦~"]},idleTips:{interval:60000,message:["你好呀~","欢迎来到我的小站~"]}}});</script></body></html>